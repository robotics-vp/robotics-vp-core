# SIMA-2 Hardening Review Pack

**Date**: 2025-11-23
**Reviewer**: Antigravity (Architectural Designer)
**Status**: CRITICAL GAPS IDENTIFIED

## 1. Executive Summary

The SIMA-2 hardening implementation has established a solid scaffolding for the pipeline, particularly in the `OntologyUpdateEngine` and `SemanticTagPropagator`. However, there are **three critical architectural gaps** that prevent the system from functioning as the "trusted semantic data pump" envisioned in the specs:

1.  **Segmentation Logic Gap**: The `SegmentationEngine` currently relies on pre-labeled primitives from the client stub, rather than implementing the raw-state-to-segment logic defined in the spec.
2.  **Rollout Coverage Gap**: The `Sima2Client` stub does not implement the required rollout templates (`failure`, `recovery`, `mixed`), rendering the stress tests insufficient for validating robustness.
3.  **Econ Correlation Gap**: The `EconCorrelator` is missing the core statistical logic to compute trust scores, meaning the "Trust Loop" is currently broken.

## 2. Gap Analysis & Correctness Check

### 2.1. Segmentation Engine (`src/sima2/segmentation_engine.py`)
*   **Spec Requirement**: Consume raw SIMA-2 states (joint positions, ee_pose, vision embeddings) and *detect* temporal boundaries and semantic labels (`approach`, `grasp`, `slip`).
*   **Current Implementation**: Consumes `primitives` that are *already present* in the input rollout (generated by the client). It essentially wraps existing primitives into `Segment` objects.
*   **Impact**: The system is not actually testing the segmentation logic. It is testing the *propagation* of pre-segmented data.
*   **Corrective Action**: `SegmentationEngine` must implement at least heuristic-based segmentation from raw `robot_state` and `object_states` (e.g., velocity thresholds, gripper status changes) to be compliant.

### 2.2. Task Library & Rollouts (`src/sima2/client.py`)
*   **Spec Requirement**: `Sima2Client` must generate four canonical templates: `template_success`, `template_failure`, `template_recovery`, `template_mixed`.
*   **Current Implementation**: Generates a single fixed trajectory per task ID ("drawer" or "dish"). No logic for injecting failures, recoveries, or OOD events.
*   **Impact**: We cannot validate `RecoveryTag` or `OODTag` propagation because the input data never contains these signals (except hardcoded "risk" labels).
*   **Corrective Action**: Upgrade `Sima2Client` to accept a `template_type` argument and generate trajectories that match the spec's structure (e.g., injecting a "slip" event and a "regroup" action for recovery templates).

### 2.3. Econ Correlation (`src/analytics/econ_correlator.py`)
*   **Spec Requirement**: Compute conditional expectations ($E[\text{Damage} | \text{RiskTag=High}]$) to derive `TrustMatrix`.
*   **Current Implementation**: Only contains data structures (`TrustEntry`) and load/save logic. No computation logic.
*   **Impact**: The "Trust Calibration" loop is non-functional. Trust scores are static or manual.
*   **Corrective Action**: Implement the statistical aggregation logic in `EconCorrelator.compute_correlations(datapacks, econ_vectors)`.

### 2.4. Tagging Divergence
*   **Observation**: The implementation uses `NoveltyTag` where the spec refers to `OODTag`.
*   **Recommendation**: Rename `NoveltyTag` to `OODTag` or alias them to ensure consistency with the spec's "OOD Containment" invariant. The `NoveltyTag` implementation (based on econ tier) is also different from the spec's visual/kinematic deviation logic.

## 3. Missing Invariants

The following invariants from the specs are not explicitly enforced in the code:

1.  **The Recovery Imperative**: "If `RiskTag.level > threshold` AND `Outcome == Success` AND NO `RecoveryTag` exists, flag as 'Lucky'."
    *   *Status*: Missing in `SemanticTagPropagator`.
2.  **OOD Containment**: "Any `OODTag` > critical must trigger `SafetyStop` unless `RecoveryTag` follows."
    *   *Status*: Missing. `SupervisionHintsGenerator` checks novelty but doesn't strictly enforce the "stop unless recovery" rule.
3.  **Fragility-Recovery Duality**: "`FragilityNode` must be paired with `RecoveryNode`."
    *   *Status*: Missing in `OntologyUpdateEngine`.

## 4. Implementation Plan (Remediation)

Codex should execute the following steps before proceeding to Phase H:

### Step 1: Upgrade Sima2Client (Priority: Critical)
*   Modify `Sima2Client` to accept `template="success"|"failure"|"recovery"|"mixed"`.
*   Implement state-machine logic to generate these sequences (e.g., `approach` -> `fail` -> `retry` -> `success`).
*   Ensure "raw" state data (mocked) reflects these events (e.g., gripper width stays open during a "slip").

### Step 2: Implement Heuristic Segmentation
*   Update `SegmentationBuilder` to ignore input primitives and instead look at `events` or `robot_state` changes.
*   Implement simple heuristics:
    *   `gripper_width` change -> `grasp`/`release` boundary.
    *   `ee_velocity` > 0 -> `move`/`approach`.
    *   `contact_force` > threshold -> `contact`.

### Step 3: Implement EconCorrelator Logic
*   Implement `compute_correlations` to iterate over `Datapack` and `EconVector` stores.
*   Calculate `RiskPremium` and `RecoveryValue` as defined in `SIMA2_ECON_CORRELATION_SPEC.md`.
*   Output a populated `trust_matrix.json`.

### Step 4: Enforce Invariants
*   Add `LuckySuccessTag` generation in `SemanticTagPropagator` (Invariant 2.1).
*   Add `SafetyStop` proposal in `TaskGraphRefiner` for unmitigated OOD (Invariant 2.2).

## 5. Final Spec for Codex

Proceed with **Step 1 (Sima2Client Upgrade)** and **Step 3 (EconCorrelator)** immediately. Step 2 can be deferred if we accept that `Sima2Client` emits "ground truth" segments for now, but Step 1 is non-negotiable for testing the pipeline.
